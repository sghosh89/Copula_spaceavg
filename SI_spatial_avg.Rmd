---
title: "Supporting Information : Asymmetric tail association affects community stability"
author: "Shyamolina Ghosh, other authors, Daniel Reuman"
date: "`r format(Sys.time(), '%d %B, %Y')`"
fontsize: 12pt
geometry: "left=1.5cm,right=1.5cm,top=1cm,bottom=1.8cm"

output: 
  pdf_document:
    number_sections: yes
    keep_tex: yes
    fig_caption: yes

header-includes:
      - \usepackage{xr} \externaldocument[MT-]{MT_spatial_avg}
      - \input{head_supp.sty}

mainfont: Times New Roman 
tables: True
link-citations: True
urlcolor : blue
indent : True
csl: ecology-letters.csl
bibliography: REF_CSS.bib
---

\pagenumbering{roman}
\tableofcontents
\listoftables
\listoffigures

\pagebreak
\pagenumbering{arabic}

<!--Basic setup-->
```{r setup, echo=F, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.pos = "H")
seed<-101 # common seed 
library(dplyr)
library(kableExtra)
library(stringr)
library(rmarkdown)
# families<-c(1,3:10,13,14,16:20)
source("mtime.R") #A function needed for caching
```

<!-- reading raw data for hays and creates results folder for hays-->
```{r read hays_rawdata,echo=F,results="hide"}
# later add results="hide" , echo=F in chunk header
set.seed(seed)
# basal cover data
cover<-read.csv("./Data/HaysData/allrecords.csv") # this is basal cover

# quadrat sampling ? Yes or not
quadsamp<-read.csv("./Data/HaysData/quadrat_inventory.csv")

quad_info<-read.csv("./Data/HaysData/quadrat_info.csv")
count_quad_grazed<-table(quad_info$Grazing) #36 No grazing, 15 Yes grazed
quad_grazing<-quad_info$quadrat[which(quad_info$Grazing=="Yes")]
quad_grazing<-as.character(quad_grazing) # we plan to exclude these 15 plots later 
                                           # when calculating averaged basal cover for each species


# Information on species list
spinfo<-read.csv("./Data/HaysData/species_list.csv")
nonplant<-as.character(spinfo$species[which(spinfo$type=="remove")]) 
#These are not plant species as per metadata file (page 8 in pdf) for more info: though I doubt on mixed grass and polygonum spp.]
#"Bare ground"    "Fragment"       "Mixed grass"    "Polygonum spp." "Unknown"
spinfo[which(spinfo$type=="remove"),] # for details

#-------creating results folder for hays data------------
if(!dir.exists("./Results/hays_results")){
  dir.create("./Results/hays_results/")
}

if(!dir.exists("./Results/hays_results/skewness_results")){
  dir.create("./Results/hays_results/skewness_results/")
}
```

<!-- preparing hays spatial average data in usual format for common+pseudo sp.-->
```{r prepare_hays_spaceavg,results="hide",echo=F,cache=T, cache.extra=list(seed,cover,spinfo,quad_grazing,nonplant)}
# later add results="hide" , echo=F in chunk header
set.seed(seed)
library(stringr)
py<-(cover$plotyear)
plots<-str_sub(string = py,start=1,end=str_length(py)-2) #extracting only plot no.
yrs<-str_sub(string = py,start=-2)        #extracting last 2digit of an year
cover<-cbind(plot=plots,yr=as.numeric(yrs),cover)

uyr<-sort(unique(cover$yr)) # 41 unique years
uplot<-sort(unique(cover$plot)) # 51 unique quadrats
uplot<-as.character(uplot)

splist<-sort(unique(cover$species))
splist<-as.character(splist)  

# check with raw data:
spcount<-as.data.frame(table(cover$species))
checkcount<-(spinfo$count==spcount$Freq)
all(checkcount=T) #These should be true

#sink("./Results/hays_results/hays_myquadsamplinginfo.txt", append=TRUE, split=TRUE)

hays_array<-array(Inf,dim=c(length(uyr),length(uplot),length(splist)),dimnames = list(uyr,uplot,splist))

for(iyr in 1:length(uyr)){
  tempo<-subset(cover,cover$yr==uyr[iyr])
  for(iplot in 1:length(uplot)){
    tempo2<-subset(tempo,tempo$plot==uplot[iplot])
    if(nrow(tempo2)==0){
      cat("iyr = ",iyr, " Year : ",uyr[iyr], "iplot = ",iplot," plot : ",uplot[iplot],"Not surveyed : --NA--","\n")
      hays_array[iyr,iplot,]<-NA # NA means this plot is not surveyed in that given year : so all species should get NA as basal cover
    }else{
      z<-split( tempo2 , f = tempo2$species ) # This will split the data tempo2 by its species levels (which is a factor)
      for(isp in 1:length(z)){
        cs<-sum(z[[isp]]$area)  # if cs=0 that means that sp. is absent for that plot and for that given year 
                                # it will sum over the area of a particular sp. taken from all ID in a quadrat
        hays_array[iyr,iplot,isp]<-cs
      }
    }
  }
}

#check with prepared data
# check1 : Total basal cover reported for any specific year from 1 sq. meter quadrat should be ~10000 cm^2
check_matcover<-apply(hays_array,FUN=sum,MARGIN=c(1,2),na.rm=T)
check_matcover[check_matcover==0]<-NA
# This check_matcover matrix contains entries either NA for plots not surveyed or 9999...value ~10000 cm^2
range(check_matcover,na.rm=T)
#hist(check_matcover,ylim=c(0,5),col="grey",breaks=100) # check with plot

#sink()

#It's a check : There should not be all zeros for all sp on any plot-year combination
s<-apply(hays_array,FUN = sum,MARGIN = c(1,2)) #This matrix should contain either NA or some +ve number
any(s==0,na.rm = T)  #There should not be any zeros

saveRDS(hays_array,"./Results/hays_results/hays_array_41yr_51plot_151sp.RDS")

# Now calculate average basal cover over all plots (except 15 grazed) for any given year for all species
avg_cover_over_plots_hays<-matrix(Inf,nrow=length(uyr),ncol=length(splist))
rownames(avg_cover_over_plots_hays)<-c(1932:1972)
colnames(avg_cover_over_plots_hays)<-splist
avg_cover_over_plots_hays<-as.data.frame(avg_cover_over_plots_hays)

#check2:

#from raw data
plotsurveyed<-rowSums(!is.na(quadsamp))-1 

#from prepared data
isp<-1 # This should be same for any species
numplot_surveyed_by_year<-apply(hays_array[,,isp], MARGIN = 1, function(x){sum(is.finite(x))}) 

all((plotsurveyed==numplot_surveyed_by_year)==T) #They are same.

for(isp in c(1:length(splist))){
  m<-hays_array[,,isp]
  
  id_grz<-which(colnames(m)%in%quad_grazing) 
  m<-m[,-id_grz] #these grazed plots should be excluded 

  idNA<-which(apply(m, 1, function(x) all(is.na(x)))) #This should be empty : means should not be all NA's along any row
  if(length(idNA)==0){
    cs<-apply(m,FUN = mean,MARGIN = 1,na.rm=T)
    avg_cover_over_plots_hays[,isp]<-cs
  }else{
    cat("Caution : This means for a given year not any plot was surveyed!!!")
  }
}
anyNA(avg_cover_over_plots_hays) #This should be FALSE

#---------saving a big matrix 41yrs by 151 sp. which has each sp (including non-plant) timeseries along each column : hays data------
saveRDS(avg_cover_over_plots_hays,"./Results/hays_results/timeseries_matrix_spatialavg_allsp_hays.RDS")

# Now screen the species for hays
count0<-apply(avg_cover_over_plots_hays,2,function(x){sum(x==0)}) # This is the count of zero 
count0_allsp<-as.data.frame(count0)

id_nonplant<-which(colnames(avg_cover_over_plots_hays)%in%nonplant)

id_common_sp_hays<-which(count0_allsp$count0<=6) # sp. present for atleast 35 yrs
id_common_sp_hays<-setdiff(id_common_sp_hays,id_nonplant)

id_rare_sp_hays<-which(count0_allsp$count0>=39) # sp. present max. for 2 yrs
id_rare_sp_hays<-setdiff(id_rare_sp_hays,id_nonplant)

id_interm_sp_hays<-which(count0_allsp$count0<39 & count0_allsp>6)
id_interm_sp_hays<-setdiff(id_interm_sp_hays,id_nonplant)

# check
tot_sp_hays<-length(id_common_sp_hays)+length(id_interm_sp_hays)+length(id_rare_sp_hays)+length(id_nonplant)
tot_sp_hays==151

sp_category_hays<-as.data.frame(matrix(NA,nrow=length(splist),ncol=3))
colnames(sp_category_hays)<-c("id","sp","category")
sp_category_hays$id<-c(1:length(splist))
sp_category_hays$sp<-splist
sp_category_hays$category[id_common_sp_hays]<-"C" #common sp. for Hays data
sp_category_hays$category[id_interm_sp_hays]<-"I" # Intermediate sp. for Hays data
sp_category_hays$category[id_rare_sp_hays]<-"R" # rare sp. for Hays data

#---------saving a 151sp by 2 matrix indicating C/I/R category for each hays-sp (for non-plant = NA)---------
saveRDS(sp_category_hays,"./Results/hays_results/all_sp_category_spatialavg_hays.RDS")

# Now make hays_spaceavg data in your format
hays_spaceavg<-vector("list",1)
names(hays_spaceavg)<-"avg.basal.cover"

sp.screened.data<-vector("list",length(id_common_sp_hays))
names(sp.screened.data)<-splist[id_common_sp_hays]

for(isp in 1:length(id_common_sp_hays)){
  sp.screened.data[[isp]]<-data.frame(Year=c(1932:1972),Dat=avg_cover_over_plots_hays[,id_common_sp_hays[isp]])
}

hays_spaceavg$avg.basal.cover<-sp.screened.data

# Append the pseudo species = merged sp. of I & R category
pseudo_hays_IR<-apply(X=avg_cover_over_plots_hays[,which(sp_category_hays$category%in%c("I","R"))],MARGIN = 1,FUN = sum)
pseudo_hays<-data.frame(Year=c(1932:1972),Dat=pseudo_hays_IR)
pseudo_hays<-list(pseudo_hays)

hays_spaceavg$avg.basal.cover<-append(hays_spaceavg$avg.basal.cover,pseudo_hays)
names(hays_spaceavg$avg.basal.cover)[[length(id_common_sp_hays)+1]]<-"pseudo_hays"

#---------saving the spatial avg. data for hays with whigh we will do taildep. analysis later----------------
saveRDS(hays_spaceavg,"./Results/hays_results/hays_spaceavg_data_CP.RDS")

#-----------saving a matrix with timeseries of common + 1 pseudo (all other merged into 1) sp. for hays------
ts_mat_CP_hays<-cbind(avg_cover_over_plots_hays[,id_common_sp_hays],pseudo_hays_IR)
saveRDS(ts_mat_CP_hays,"./Results/hays_results/skewness_results/ts_mat_CP_hays.RDS")

#------------------------- plot total timeseries for hays data ------------------------------------------------
pdf("./Results/hays_results/skewness_results/total_timeseries.pdf",height=6,width=6)
op<-par(mar=c(5.1, 5.1, 1.1, 2.1))

total_ts_C<-apply(X=avg_cover_over_plots_hays[,id_common_sp_hays],MARGIN = 1,FUN = sum)
total_ts_CI<-apply(X=avg_cover_over_plots_hays[,sort(c(id_common_sp_hays,id_interm_sp_hays))],MARGIN = 1,FUN = sum)
total_ts_CIR<-apply(X=avg_cover_over_plots_hays[,sort(c(id_common_sp_hays,id_interm_sp_hays,id_rare_sp_hays))],MARGIN = 1,FUN = sum)
total_ts<-cbind(total_ts_C,total_ts_CI,total_ts_CIR)
plot(c(1932:1972),total_ts[,1],ylim=c(range(total_ts)[1],10000),col=rgb(1,0,0,0.5),type="b",pch=16,xlab="Years",ylab="Total basal cover",xlim=c(1932,1972),cex.lab=2,cex.axis=2)
lines(c(1932:1972),total_ts[,2],type="b",pch=16,col=rgb(0,1,0,0.5))
lines(c(1932:1972),total_ts[,3],type="b",col="black",pch=1)
legend("topright",c("common sp.","common + intermediate sp.","all sp. including rare"),lty=c(1,1,1),
       col=c(rgb(1,0,0,0.5),rgb(0,1,0,0.5),"black"),pch=c(16,16,1),bty="n",cex=1.2)
par(op)
dev.off()


#------plot hays_spaceavg data for all screened sp for all yearspan-------------------------------
pdf("./Results/hays_results/hays_spaceavg_screenedsp_avgcover.pdf",height = 21,width=21)
op<-par(mfrow=c(6,5),mar=c(5,3,3,3))
for (i in c(1:length(hays_spaceavg$avg.basal.cover))){
  plot(hays_spaceavg$avg.basal.cover[[i]]$Year,hays_spaceavg$avg.basal.cover[[i]]$Dat,col=rgb(0,0,1,0.3),pch=19,type="b",
       ylim=c(0,max(hays_spaceavg$avg.basal.cover[[i]]$Dat,na.rm=T)),xlab="Year (1932-1972)")
  abline(h=0)
  n0<-sum(hays_spaceavg$avg.basal.cover[[i]]$Dat==0)
  mtext(paste0("sp = ",i," : ",names(hays_spaceavg$avg.basal.cover)[i],", n0=",n0,sep=""))
}
par(op)
dev.off()

# ---------------------generate copula plots for all selected splist_hays_spaceavg--------------------
source("./vivj_matrix.R")
include_indep<-FALSE
good_sp<-c(1:length(hays_spaceavg[[1]]))
lensp<-length(good_sp)
pdf("./Results/hays_results/copula_hays_spaceavg.pdf",height=2*lensp,width = 2*lensp)
op<-par(mfrow=c(lensp,lensp),mar=c(3,3,3,3), mgp=c(1.5,0.5,0))
for(i in c(1:lensp)){
  for(j in c(1:lensp)){
    vivj_matrix(d_allsp=hays_spaceavg,loc=1,
                i=good_sp[i],j=good_sp[j],level=0.05,
                ploton=T,onbounds=T,lb=0,ub=0.5,include_indep=include_indep)
  }
}
par(op)
dev.off()
```

<!-- non-parametric analysis for cor stat with common + pseudo sp. in hays-->
```{r npa_hays_spaceavg, echo=F, cache=T, cache.extra=list(seed,hays_spaceavg,mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

set.seed(seed) 
source("./NonParamStat.R")

if(!dir.exists("./Results/hays_results/corstat_hays_spaceavg_results")){
  dir.create("./Results/hays_results/corstat_hays_spaceavg_results")
} 

resloc<-"./Results/hays_results/corstat_hays_spaceavg_results/"
nbin_hays<-2
include_indep<-FALSE 

corstat_hays_spaceavg<-multcall(d_allsp=hays_spaceavg,
                           loc=1,
                           resloc=resloc,
                           good_sp=c(1:length(hays_spaceavg[[1]])),
                           nbin=nbin_hays,include_indep=include_indep)

saveRDS(corstat_hays_spaceavg,paste(resloc,file="corstat_hays_spaceavg_nbin_",nbin_hays,".RDS",sep=''))
```

<!-- genarating Corl - Coru plots from non-parametric analysis with common + pseudo sp. in hays-->
```{r plot_res_hays_npa_spaceavg, echo=F, results="hide",cache=T,warning=F, cache.extra=list(seed,hays_spaceavg,corstat_hays_spaceavg,nbin_hays,mtime("NonParamStat_matrixplot.R"),mtime("mycorrplot_with_sig.R"),mtime("tailsignif.R"),mtime("CopulaFunctions_flexible.R"))}
set.seed(seed)
source("./NonParamStat_matrixplot.R")

resloc<-"./Results/hays_results/corstat_hays_spaceavg_results/"

ub<-1/nbin_hays
numpts<-length(hays_spaceavg$avg.basal.cover[[1]]$Year)  #for hays data 41years
numsims<-10000
CI<-c(0.025,0.975)
sigtest<-FALSE
include_indep<-FALSE 

CorlmCoru_hays_spaceavg<-NonParamStat_matrixplot(data=corstat_hays_spaceavg,resloc=resloc,tagon=T,
                                                 type="lower",wd=13,ht=13,
                                                 sigtest=sigtest,ub=ub,numpts=numpts,
                                                 numsims=numsims,CI=CI,include_indep=include_indep)
saveRDS(CorlmCoru_hays_spaceavg,paste(resloc,file="CorlmCoru_hays_spaceavg_nbin_",nbin_hays,".RDS",sep='')) 
```

```{r binom_sigtest_hays, echo=F}
# only run this chunk if sigtest=TRUE in previous chunks
#source("./binomial_sigtest.R")
# set.seed(seed=101) # not needed as binom test uses two-sided binom.test function 
# also it does not matter here binom_sig="LT" or binom_sig="UT"
#sigtest_hays<-binomial_sigtest(ylist=CorlmCoru_hays_spaceavg,binom_sig="LT") 
```

<!--get appropriate surrogates for hays with common+pseudo sp.-->
```{r make_surrogs_CP_hays, echo=F, results="hide", warning=F, cache=T, cache.extra=list(ts_mat_CP_hays,mtime("PPSurrogObjFun.R"),mtime("pwlin.R"),mtime("getmap.R"),mtime("alignranks.R"),mtime("SurrogsForHays.R"))}

source("SurrogsForHays.R")
#after this script runs the surrogates will be in the variable surrogs_CP_hays
# and saved as ./Results/hays_results/skewness_results/pp_surrogs_hays_CP/HaysSurrogates.RDS
```

<!-- genarating stability based results and plots for hays-->
```{r skewness_hays_spaceavg_PP, echo=F, results="hide", warning=F, cache=T, cache.extra=list(seed,ts_mat_CP_hays,surrogs_CP_hays,mtime("make_tab_stability_assessment.R"),mtime("mycvsq.R"),mtime("SkewnessAnd3CentMom.R"))}

set.seed(seed)
source("make_tab_stability_assessment.R")

# randomly sample numsurrog surrogate matrices from Pearson preserving array
numsurrog<-10000
id_surrogs<-sample(c(1:dim(surrogs_CP_hays)[3]),numsurrog,replace=F)
surrogs_CP_hays_sampled<-surrogs_CP_hays[,,id_surrogs]

stability_CP_hays<-make_tab_stability(m=ts_mat_CP_hays,surrogs = surrogs_CP_hays_sampled, surrogs_given = T)
ans<-(stability_CP_hays$df_stability)
rownames(ans)<-"C+P"
class(ans)

write.csv(ans,"./Results/hays_results/skewness_results/hays_stability_CP.csv")

#--------------generate plots with hays stability results : CVsq and skewness-------------------------------

pdf("./Results/hays_results/skewness_results/hays_pearson_preserving_results_cvsq_skw_plots.pdf",height=5,width=10)

op<-par(mfrow=c(1,2),mar=c(6,5,0.1,2),mgp=c(3,1,0))

#--------------CVsq histogrm-------------------------------------
xlm<-range(ans$cvsq_real,ans$cvsq_indep,stability_CP_hays$cvsq_surrogs)

hist(stability_CP_hays$cvsq_surrogs,col="grey",border=F,breaks=100,xaxt="n",xlim=xlm,
     xlab="CVsq. of Surrogates",main="",cex.lab=1.5)
axis(side=1, at=round(c(xlm[1],xlm[2]),3))
points(x=ans$cvsq_real,y=0,col="black",pch=20,cex=1) # actual CVsq from real data
#abline(v=ans$cvsq_real,col="black") # actual CVsq from real data

#95% quantiles
abline(v=ans$cvsq_ntd_0.025CI,col="black",lty="dotted") 
abline(v=ans$cvsq_ntd_0.975CI,col="black",lty="dotted")

#50% quantiles
#CI_cvsq_50<-quantile(stability_CP_hays$cvsq_surrogs,probs=c(.25,.75))
#abline(v=CI_cvsq_50[1],col="green")
#abline(v=CI_cvsq_50[2],col="green")

# Cvsq with no tail dep.
points(x=ans$cvsq_ntd_median,y=0,col="black",pch=2,cex=1.5)

# Cvsq if indep.
abline(v=ans$cvsq_indep,col="black",lty="dashed")


#--------------skw histogrm-------------------------------------
xlm<-range(ans$skw_real,ans$skw_indep,stability_CP_hays$skw_surrogs)

hist(stability_CP_hays$skw_surrogs,col="grey",border=F,breaks=100,xaxt="n",xlim=xlm,
     xlab="Skewness of Surrogates",main="",cex.lab=1.5)
axis(side=1, at=round(c(xlm[1],0,xlm[2]),3))
points(x=ans$skw_real,y=0,col="black",pch=20,cex=1) # actual skw from real data

#95% quantiles
abline(v=ans$skw_ntd_0.025CI,col="black",lty="dotted") 
abline(v=ans$skw_ntd_0.975CI,col="black",lty="dotted")

#50% quantiles
#CI_skw_50<-quantile(stability_CP_hays$skw_surrogs,probs=c(.25,.75))
#abline(v=CI_skw_50[1],col="green")
#abline(v=CI_skw_50[2],col="green")

# Skewness with no tail dep.
points(x=ans$skw_ntd_median,y=0,col="black",pch=2,cex=1.5)

# Skewness if indep.
abline(v=ans$skw_indep,col="black",lty="dashed")

# add legend
#legend("topright",lty=c(1,NA,2,3),pch=c(NA,1,NA,NA),
#       horiz = F, bty="n",
#       legend=c("real value","no Tail-dep. (median)","95%CI","Indep."))
par(op)
dev.off()

pdf("./Results/hays_results/skewness_results/legend_plot.pdf",height=0.5,width=11)
op<-par(mar=c(0.1,0.1,0.1,0.1),mgp=c(1,1,0))

plot.new()
legend("topright",lty=c(NA,NA,3,2),pch=c(20,2,NA,NA),
       horiz = T, bty="n",
       legend=c("real value,","no Tail-dep. (median),","95%CI,","Indep."),x.intersp=0, text.width = 0.22)
#par(op)
dev.off()
```

```{r few_checks_on_surrogs_hays, echo=F, results="hide", cache=T, cache.extra=list(seed,ts_mat_CP_hays,surrogs_CP_hays,mtime("PPsurrogs_tests.R"),mtime("get_var_ratio.R"))}
set.seed(seed)
source("./PPsurrogs_tests.R")

# randomly sample numsurrog surrogate matrices from Pearson preserving array
numsurrog<-10000
id_surrogs<-sample(c(1:dim(surrogs_CP_hays)[3]),numsurrog,replace=F)
surrogs_CP_hays_sampled<-surrogs_CP_hays[,,id_surrogs]

ans<-PPsurrogs_tests(m=ts_mat_CP_hays, surrogs=surrogs_CP_hays_sampled)
#ans<-PPsurrogs_tests(m=ts_mat_CP_hays, surrogs=surrogs_CP_hays)
saveRDS(ans,"./Results/hays_results/skewness_results/pp_surrogs_hays_CP/PPsurrogs_tests_with_HaysSurrogates.RDS")
```

```{r plotter_PPsurrogs_check_hays, echo=F, results="hide", cache=T, cache.extra=list(seed,ts_mat_CP_hays,mtime("./Results/hays_results/skewness_results/pp_surrogs_hays_CP/PPsurrogs_tests_with_HaysSurrogates.RDS"),mtime("Plotter_PPsurrogs_tests.R"))}

set.seed(seed)
source("./Plotter_PPsurrogs_tests.R")

m<-ts_mat_CP_hays
ans<-readRDS("./Results/hays_results/skewness_results/pp_surrogs_hays_CP/PPsurrogs_tests_with_HaysSurrogates.RDS")
resloc<-"./Results/hays_results/skewness_results/pp_surrogs_hays_CP/"

Plotter_PPsurrogs_tests(m=m,ans=ans,resloc=resloc)
```

<!--some additional fig for suppmat : hays-->
```{r hays_spaceavg_some_figs,echo=F,results="hide"}
source("vivj_matrix.R")
include_indep<-FALSE

#UT dep. among all dry seasoned deep rooted grasses
pdf("./Results/hays_results/hays_spaceavg_ANGE_PAVI2_PSTE5.pdf",height=3,width=10)
op<-par(mfrow=c(1,3),mar=c(5,5,2,2))
i<-2
j<-11
d_allsp<-hays_spaceavg
s1<-vivj_matrix(d_allsp=d_allsp,loc=1,i=i,j=j,ploton=F,onbounds=F,lb=NA,ub=NA,include_indep=include_indep)
plot(s1$mat[,1],s1$mat[,2],col=rgb(0,0,0,0),pch=19,xlab=names(d_allsp[[1]])[i],
     ylab=names(d_allsp[[1]])[j],cex.lab=1.5)
text(s1$mat[,1],s1$mat[,2],labels = c(1932:1972),cex=0.6,col="blue")
mtext(paste0("(sp_x, sp_y) = (",i," , ",j,")"),
          side = 3, line=0.15, adj=0.5, col="black")

i<-2
j<-13
d_allsp<-hays_spaceavg
s1<-vivj_matrix(d_allsp=d_allsp,loc=1,i=i,j=j,ploton=F,onbounds=F,lb=NA,ub=NA,include_indep=include_indep)
plot(s1$mat[,1],s1$mat[,2],col=rgb(0,0,0,0),pch=19,xlab=names(d_allsp[[1]])[i],
     ylab=names(d_allsp[[1]])[j],cex.lab=1.5)
text(s1$mat[,1],s1$mat[,2],labels = c(1932:1972),cex=0.6,col="blue")
mtext(paste0("(sp_x, sp_y) = (",i," , ",j,")"),
          side = 3, line=0.15, adj=0.5, col="black")

i<-11
j<-13
d_allsp<-hays_spaceavg
s1<-vivj_matrix(d_allsp=d_allsp,loc=1,i=i,j=j,ploton=F,onbounds=F,lb=NA,ub=NA,include_indep=include_indep)
plot(s1$mat[,1],s1$mat[,2],col=rgb(0,0,0,0),pch=19,xlab=names(d_allsp[[1]])[i],
     ylab=names(d_allsp[[1]])[j],cex.lab=1.5)
text(s1$mat[,1],s1$mat[,2],labels = c(1932:1972),cex=0.6,col="blue")
mtext(paste0("(sp_x, sp_y) = (",i," , ",j,")"),
          side = 3, line=0.15, adj=0.5, col="black")

par(op)
dev.off()


pdf("./Results/hays_results/hays_spaceavg_SCSC_interactions.pdf",height=10,width=6)
op<-par(mfrow=c(4,2),mar=c(4,5,3,3))
i<-5
j<-14
d_allsp<-hays_spaceavg

vivj_matrix(d_allsp = d_allsp,loc=1,i=i,j=j,ploton=T,onbounds=F,lb=NA,ub=NA,include_indep=include_indep)

s1<-vivj_matrix(d_allsp=d_allsp,loc=1,i=i,j=j,ploton=F,onbounds=F,lb=NA,ub=NA,include_indep=include_indep)
plot(s1$mat[,1],s1$mat[,2],col=rgb(0,0,0,0),pch=19,xlab=names(d_allsp[[1]])[i],
     ylab=paste("-",names(d_allsp[[1]])[j],sep=""),cex.lab=1.5)
text(s1$mat[,1],s1$mat[,2],labels = c(1932:1972),cex=0.5,col="blue")

i<-12
j<-14
d_allsp<-hays_spaceavg

vivj_matrix(d_allsp = d_allsp,loc=1,i=i,j=j,ploton=T,onbounds=F,lb=NA,ub=NA,include_indep=include_indep)

s1<-vivj_matrix(d_allsp=d_allsp,loc=1,i=i,j=j,ploton=F,onbounds=F,lb=NA,ub=NA,include_indep=include_indep)
plot(s1$mat[,1],s1$mat[,2],col=rgb(0,0,0,0),pch=19,xlab=names(d_allsp[[1]])[i],
     ylab=paste("-",names(d_allsp[[1]])[j],sep=""),cex.lab=1.5)
text(s1$mat[,1],s1$mat[,2],labels = c(1932:1972),cex=0.5,col="blue")

i<-17
j<-14
d_allsp<-hays_spaceavg

vivj_matrix(d_allsp = d_allsp,loc=1,i=i,j=j,ploton=T,onbounds=F,lb=NA,ub=NA,include_indep=include_indep)

s1<-vivj_matrix(d_allsp=d_allsp,loc=1,i=i,j=j,ploton=F,onbounds=F,lb=NA,ub=NA,include_indep=include_indep)
plot(s1$mat[,1],s1$mat[,2],col=rgb(0,0,0,0),pch=19,xlab=names(d_allsp[[1]])[i],
     ylab=paste("-",names(d_allsp[[1]])[j],sep=""),cex.lab=1.5)
text(s1$mat[,1],s1$mat[,2],labels = c(1932:1972),cex=0.5,col="blue")

i<-18
j<-14
d_allsp<-hays_spaceavg

vivj_matrix(d_allsp = d_allsp,loc=1,i=i,j=j,ploton=T,onbounds=F,lb=NA,ub=NA,include_indep=include_indep)

s1<-vivj_matrix(d_allsp=d_allsp,loc=1,i=i,j=j,ploton=F,onbounds=F,lb=NA,ub=NA,include_indep=include_indep)
plot(s1$mat[,1],s1$mat[,2],col=rgb(0,0,0,0),pch=19,xlab=names(d_allsp[[1]])[i],
     ylab=paste("-",names(d_allsp[[1]])[j],sep=""),cex.lab=1.5)
text(s1$mat[,1],s1$mat[,2],labels = c(1932:1972),cex=0.5,col="blue")

par(op)
dev.off()
```

<!-- preparing spatial avg data in usual format with common+pseudo sp. for knz data-->
```{r read_and_prepare_knz_data,echo=F,results="hide",cache=T, cache.extra=list(seed,mtime("./Data/KnzData/KNZ_Data_downloaded/knb-lter-knz.69.15/PVC021.csv"),mtime("./Data/KnzData/KNZ_Data_downloaded/KFH011.csv"))}
set.seed(seed)
source("./data_cleaning_for_KNZ.R")
```

```{r screen_sp_for_knz_data,echo=F,results="hide",cache=T,cache.extra=list(seed,mtime("data_cleaning_for_KNZ.R"))}
set.seed(seed)
# knz_soiltype<-"t" # given variable for soil type in ./data_cleaning_for_KNZ.R

# the data cleaning file saves ts_all_sp_knz matrix as "./Results/knz_results/ts_all_sp_knz_soiltype_t.RDS"

#================ screening for common-intermediate-rare species category ================

ts_all_sp_knz<-readRDS(paste(resloc_knz,"ts_all_sp_knz_soiltype_",knz_soiltype,".RDS",sep=""))

# count on zero values for cover for each species
nyr_0_eachsp<-apply(ts_all_sp_knz,MARGIN = 2,FUN = function(x){sum(x==0)})
nyr_0_eachsp<-as.data.frame(nyr_0_eachsp)

# common sp. for KNZ : these sp present for atleast 35 years, i.e., absent for max 1 years
id_common_sp_knz<-which(nyr_0_eachsp$nyr_0_eachsp<=1) 
ts_common_knz<-ts_all_sp_knz[,id_common_sp_knz]

# rare sp. for KNZ : absent for atleast 34 years, i.e. present max only for 2 years
id_rare_sp_knz<-which(nyr_0_eachsp$nyr_0_eachsp>=34)
ts_rare_knz<-ts_all_sp_knz[,id_rare_sp_knz]

# normal or intermediate sp. for KNZ
id_interm_sp_knz<-which(nyr_0_eachsp$nyr_0_eachsp>1 & nyr_0_eachsp$nyr_0_eachsp<34)
ts_normal_knz<-ts_all_sp_knz[,id_interm_sp_knz]

# sp. category for KNZ
sp_category_knz<-data.frame(sp=rownames(nyr_0_eachsp),category=NA)
sp_category_knz$category[id_common_sp_knz]<-"C"
sp_category_knz$category[id_interm_sp_knz]<-"I"
sp_category_knz$category[id_rare_sp_knz]<-"R"

#---------saving a 125sp by 2 matrix indicating C/I/R category for each knz-sp---------
saveRDS(sp_category_knz,paste(resloc_knz,"all_sp_category_spatialavg_knz_soiltype_",knz_soiltype,".RDS",sep=""))

#===========================Formatting data for tail-asymmetry analysis========================

# Now make the usual format for KNZ data (with common sp and all other merged into a pseudo species) to 
# be used in tail-asymmetry analysis later

knz_spaceavg<-vector("list",1)
names(knz_spaceavg)<-"avg.percent.cover"

sp.screened.data<-vector("list",length(id_common_sp_knz))
names(sp.screened.data)<-rownames(nyr_0_eachsp)[id_common_sp_knz]

for(isp in 1:length(id_common_sp_knz)){
  sp.screened.data[[isp]]<-data.frame(Year=c(1983:2018),Dat=ts_common_knz[,isp])
}

knz_spaceavg$avg.percent.cover<-sp.screened.data

# Append the pseudo species = merged sp. of I & R category
pseudo_knz_IR<-apply(X=ts_all_sp_knz[,which(sp_category_knz$category%in%c("I","R"))],MARGIN = 1,FUN = sum)
pseudo_knz<-data.frame(Year=c(1983:2018),Dat=pseudo_knz_IR)
pseudo_knz<-list(pseudo_knz)

knz_spaceavg$avg.percent.cover<-append(knz_spaceavg$avg.percent.cover,pseudo_knz)
names(knz_spaceavg$avg.percent.cover)[[length(id_common_sp_knz)+1]]<-"pseudo_knz"

#---------saving the spatial avg. data for knz with whigh we will do taildep. analysis later----------------
saveRDS(knz_spaceavg,paste(resloc_knz,"knz_spaceavg_data_CP_soiltype_",knz_soiltype,".RDS",sep=""))

#-----------saving a dataframe with timeseries of common + 1 pseudo (all other merged into 1) sp. for knz------
ts_CP_knz<-cbind(ts_common_knz,pseudo_knz_IR)
saveRDS(ts_CP_knz,paste(resloc_knz_skw,"ts_CP_knz_soiltype_",knz_soiltype,".RDS",sep="")) 

#-------- time series plot for knz Common sp, Common + Normal(or Intermediate) sp., Common+Normal+Rare sp.----------

pdf(paste(resloc_knz_skw,"total_timeseries_soiltype_",knz_soiltype,".pdf",sep=""),height=6,width=6)
op<-par(mar=c(5.1, 5.1, 1.1, 2.1))

total_ts_C<-apply(X=ts_all_sp_knz[,id_common_sp_knz],MARGIN = 1,FUN = sum)
total_ts_CI<-apply(X=ts_all_sp_knz[,sort(c(id_common_sp_knz,id_interm_sp_knz))],MARGIN = 1,FUN = sum)
total_ts_CIR<-apply(X=ts_all_sp_knz[,sort(c(id_common_sp_knz,id_interm_sp_knz,id_rare_sp_knz))],MARGIN = 1,FUN = sum)
total_ts<-cbind(total_ts_C,total_ts_CI,total_ts_CIR)
plot(c(1983:2018),total_ts[,1],ylim=range(total_ts),col=rgb(1,0,0,0.5),type="b",pch=16,xlab="Years",ylab="Total percent cover",xlim=c(1983,2018),cex.lab=2,cex.axis=2)
lines(c(1983:2018),total_ts[,2],type="b",pch=16,col=rgb(0,1,0,0.5))
lines(c(1983:2018),total_ts[,3],type="b",col="black",pch=1)
legend("topright",c("common sp.","common + intermediate sp.","all sp. including rare"),lty=c(1,1,1),
       col=c(rgb(1,0,0,0.5),rgb(0,1,0,0.5),"black"),pch=c(16,16,1),bty="n",cex=1.2)
par(op)
dev.off()

#------plot knz_spaceavg data for all common sp for all yearspan-------------------------------
good_sp<-c(1:length(knz_spaceavg[[1]]))
lensp<-length(good_sp)

summary_knz_commonsp<-data.frame(sp=names(knz_spaceavg$avg.percent.cover),n0=NA,nTies=NA)
pdf(paste(resloc_knz,"rawplot_knz_spaceavg_commonsp_with_pseudosp_avgcover_soiltype_",knz_soiltype,".pdf",sep=""),height = 0.5*lensp,width=0.5*lensp)
op<-par(mfrow=c(6,5),mar=c(5,5,3,3))
for (i in good_sp){
  n0<-sum(knz_spaceavg$avg.percent.cover[[i]]$Dat==0)
  nTies<-sum(duplicated(knz_spaceavg$avg.percent.cover[[i]]$Dat)==T)
  summary_knz_commonsp$n0[i]<-n0
  summary_knz_commonsp$nTies[i]<-nTies
  if(n0==0){
    col1<-rgb(1,0,0,0.3) # these are the sp. present for all years 
  }else{
    col1<-rgb(0,0,1,0.3)
  }
  plot(knz_spaceavg$avg.percent.cover[[i]]$Year,knz_spaceavg$avg.percent.cover[[i]]$Dat,col=col1,pch=19,
       ylim=c(0,max(knz_spaceavg$avg.percent.cover[[i]]$Dat)),xlab="Year (1983-2018)",type="b",ylab="avg. % cover")
  abline(h=0)
  
  mtext(paste0("sp = ",i," : ",names(knz_spaceavg$avg.percent.cover)[i]," ,nT=",nTies,sep=""))
}
par(op)
dev.off()

# ---------------------generate copula plots for all common sp for knz_spaceavg--------------------
source("./vivj_matrix.R")

include_indep<-FALSE

pdf(paste(resloc_knz,"copulaplot_knz_spaceavg_commonsp_with_pseudosp_avgcover_soiltype_",knz_soiltype,".pdf",sep=""),height=2*lensp,width = 2*lensp)
op<-par(mfrow=c(lensp,lensp),mar=c(3,3,3,3), mgp=c(1.5,0.5,0))
for(i in c(1:lensp)){
  for(j in c(1:lensp)){
    vivj_matrix(d_allsp=knz_spaceavg,loc=1,
                i=good_sp[i],j=good_sp[j],level=0.05,
                ploton=T,onbounds=T,lb=0,ub=0.5,include_indep=include_indep)
  }
}
par(op)
dev.off()
```

<!-- non-parametric analysis for cor stat with common + pseudo sp. in knz-->
```{r npa_knz_spaceavg, echo=F, cache=T, cache.extra=list(seed,knz_spaceavg,mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

set.seed(seed) 
source("./NonParamStat.R")

resloc_knz_npa<-paste(resloc_knz,"corstat_knz_spaceavg_results/",sep="")

if(!dir.exists(resloc_knz_npa)){
  dir.create(resloc_knz_npa)
}

resloc2<-paste(resloc_knz_npa,"soiltype_",knz_soiltype,"/",sep="")
if(!dir.exists(resloc2)){
  dir.create(resloc2)
}

resloc<-resloc2
nbin_knz<-2
include_indep<-FALSE 

corstat_knz_spaceavg<-multcall(d_allsp=knz_spaceavg,
                               loc=1,
                               resloc=resloc,
                               good_sp=c(1:length(knz_spaceavg[[1]])),
                               nbin=nbin_knz,include_indep=include_indep)

saveRDS(corstat_knz_spaceavg,paste(resloc,file="corstat_knz_spaceavg_nbin_",nbin_knz,".RDS",sep=''))
```

<!-- genarating Corl - Coru plots from non-parametric analysis with common + pseudo sp. in knz-->
```{r plot_res_knz_npa_spaceavg, echo=F, results="hide",cache=T,warning=F, cache.extra=list(seed,knz_spaceavg,resloc2,corstat_knz_spaceavg,nbin_knz,mtime("NonParamStat_matrixplot.R"),mtime("mycorrplot_with_sig.R"),mtime("tailsignif.R"),mtime("CopulaFunctions_flexible.R"))}
set.seed(seed)
source("./NonParamStat_matrixplot.R")

resloc<-resloc2

ub<-1/nbin_knz
numpts<-length(knz_spaceavg$avg.percent.cover[[1]]$Year) #for knz data 33years
numsims<-10000
CI<-c(0.025,0.975)
sigtest<-FALSE
include_indep<-FALSE

CorlmCoru_knz_spaceavg<-NonParamStat_matrixplot(data=corstat_knz_spaceavg,
                                                resloc=resloc,tagon=T,
                                                type="lower",wd=15,ht=15,
                                                sigtest=sigtest,ub=ub,numpts=numpts,numsims=numsims,CI=CI,
                                                include_indep=include_indep)
saveRDS(CorlmCoru_knz_spaceavg,paste(resloc,file="CorlmCoru_knz_spaceavg_nbin_",nbin_knz,".RDS",sep=''))
```

```{r binom_sigtest_knz, echo=F}
# only run this chunk if sigtest=TRUE in previous chunks
#source("./binomial_sigtest.R")
# set.seed(seed=101) # not needed as binom test uses two-sided binom.test function 
# also it does not matter here binom_sig="LT" or binom_sig="UT"
#sigtest_knz<-binomial_sigtest(ylist=CorlmCoru_knz_spaceavg,binom_sig="LT") 
```

```{r read knz_data_soiltype_t, echo=F} 
#do not cache
ts_mat_CP_knz<-readRDS("./Results/knz_results/skewness_results/ts_CP_knz_soiltype_t.RDS")
```

<!--get appropriate surrogates for knz with common+pseudo sp.-->
```{r make_surrogs_CP_knz_t, echo=F, results="hide", warning=F, cache=T,cache.extra=list(ts_mat_CP_knz,mtime("PPSurrogObjFun.R"),mtime("pwlin.R"),mtime("getmap.R"),mtime("alignranks.R"),mtime("SurrogsForKonza_t.R"))}

source("./SurrogsForKonza_t.R")
#after this script runs the surrogates will be in the variable surrogs_CP_KNZ_t
```

<!-- genarating stability based results and plots for knz-->
```{r skewness_knz_spaceavg_PP, echo=F, results="hide", warning=F, cache=T, cache.extra=list(seed,surrogs_CP_KNZ_t,ts_mat_CP_knz,mtime("make_tab_stability_assessment.R"),mtime("mycvsq.R"),mtime("SkewnessAnd3CentMom.R"))}

set.seed(seed)
source("make_tab_stability_assessment.R")

surrogs_CP_knz<-surrogs_CP_KNZ_t # available from SurrogsForKonza_t.R file

# randomly sample numsurrog surrogate matrices from Pearson preserving array
numsurrog<-10000
id_surrogs<-sample(c(1:dim(surrogs_CP_knz)[3]),numsurrog,replace=F)
surrogs_CP_knz_sampled<-surrogs_CP_knz[,,id_surrogs]

stability_CP_knz<-make_tab_stability(m=ts_mat_CP_knz,surrogs = surrogs_CP_knz_sampled, surrogs_given = T)
ans<-(stability_CP_knz$df_stability)
rownames(ans)<-"C+P"
class(ans)

write.csv(ans,"./Results/knz_results/skewness_results/knz_stability_CP.csv")

#--------------generate plots with knz stability results : CVsq and skewness-------------------------------

pdf("./Results/knz_results/skewness_results/knz_pearson_preserving_results_cvsq_skw_plots.pdf",height=5,width=10)
op<-par(mfrow=c(1,2),mar=c(6,5,0.1,2),mgp=c(3,1,0))

#--------------CVsq histogrm-------------------------------------
xlm<-range(ans$cvsq_real,ans$cvsq_indep,stability_CP_knz$cvsq_surrogs)

hist(stability_CP_knz$cvsq_surrogs,col="grey",border=F,breaks=100,xaxt="n",xlim=xlm,
     xlab="CVsq. of Surrogates",main="",cex.lab=1.5)
axis(side=1, at=round(c(xlm[1],xlm[2]),3))
points(x=ans$cvsq_real,y=0,col="black",pch=20,cex=1)  # actual CVsq from real data
#abline(v=ans$cvsq_real,col="black") # actual CVsq from real data

#95% quantiles
abline(v=ans$cvsq_ntd_0.025CI,col="black",lty="dotted") 
abline(v=ans$cvsq_ntd_0.975CI,col="black",lty="dotted")

#50% quantiles
#CI_cvsq_50<-quantile(stability_CP_knz$cvsq_surrogs,probs=c(.25,.75))
#abline(v=CI_cvsq_50[1],col="green")
#abline(v=CI_cvsq_50[2],col="green")

# Cvsq with no tail dep.
points(x=ans$cvsq_ntd_median,y=0,col="black",pch=2,cex=1.5)

# Cvsq if indep.
abline(v=ans$cvsq_indep,col="black",lty="dashed")


#--------------skw histogrm-------------------------------------
xlm<-range(ans$skw_real,ans$skw_indep,stability_CP_knz$skw_surrogs)

hist(stability_CP_knz$skw_surrogs,col="grey",border=F,breaks=100,xaxt="n",xlim=xlm,
     xlab="Skewness of Surrogates",main="",cex.lab=1.5)
axis(side=1, at=round(c(xlm[1],0,xlm[2]),3))
points(x=ans$skw_real,y=0,col="black",pch=20,cex=1) # actual skw from real data
#abline(v=ans$skw_real,col="black") # actual skw from real data

#95% quantiles
abline(v=ans$skw_ntd_0.025CI,col="black",lty="dotted") 
abline(v=ans$skw_ntd_0.975CI,col="black",lty="dotted")

#50% quantiles
#CI_skw_50<-quantile(stability_CP_knz$skw_surrogs,probs=c(.25,.75))
#abline(v=CI_skw_50[1],col="green")
#abline(v=CI_skw_50[2],col="green")

# Skewness with no tail dep.
points(x=ans$skw_ntd_median,y=0,col="black",pch=2,cex=1.5)

# Skewness if indep.
abline(v=ans$skw_indep,col="black",lty="dashed")

# add legend
#legend("topright",lty=c(1,NA,2,3),pch=c(NA,1,NA,NA),
#       horiz = F, bty="n",
#       legend=c("real value","no Tail-dep. (median)","95%CI","Indep."))
par(op)
dev.off()

pdf("./Results/knz_results/skewness_results/legend_plot.pdf",height=0.5,width=11)
op<-par(mar=c(0.1,0.1,0.1,0.1),mgp=c(1,1,0))

plot.new()
legend("topright",lty=c(NA,NA,3,2),pch=c(20,2,NA,NA),
       horiz = T, bty="n",
       legend=c("real value,","no Tail-dep. (median),","95%CI,","Indep."),x.intersp=0, text.width = 0.22)
#par(op)
dev.off()
```

```{r few_checks_on_surrogs_knz, echo=F, results="hide", cache=T, cache.extra=list(seed,ts_mat_CP_knz,surrogs_CP_KNZ_t,mtime("PPsurrogs_tests.R"),mtime("get_var_ratio.R"))}
set.seed(seed)
source("./PPsurrogs_tests.R")

# randomly sample numsurrog surrogate matrices from Pearson preserving array
numsurrog<-10000
id_surrogs<-sample(c(1:dim(surrogs_CP_KNZ_t)[3]),numsurrog,replace=F)
surrogs_CP_KNZ_t_sampled<-surrogs_CP_KNZ_t[,,id_surrogs]

ans<-PPsurrogs_tests(m=ts_mat_CP_knz, surrogs=surrogs_CP_KNZ_t_sampled)
#ans<-PPsurrogs_tests(m=ts_mat_CP_knz, surrogs=surrogs_CP_KNZ_t)
saveRDS(ans,"./Results/knz_results/skewness_results/pp_surrogs_knz_t_CP/PPsurrogs_tests_with_KNZtSurrogates.RDS")
```

```{r plotter_PPsurrogs_check_knz, echo=F, results="hide", cache=T, cache.extra=list(seed,ts_mat_CP_knz,mtime("./Results/knz_results/skewness_results/pp_surrogs_knz_t_CP/PPsurrogs_tests_with_KNZtSurrogates.RDS"),mtime("Plotter_PPsurrogs_tests.R"))}

set.seed(seed)
source("./Plotter_PPsurrogs_tests.R")

m<-ts_mat_CP_knz
ans<-readRDS("./Results/knz_results/skewness_results/pp_surrogs_knz_t_CP/PPsurrogs_tests_with_KNZtSurrogates.RDS")
resloc<-"./Results/knz_results/skewness_results/pp_surrogs_knz_t_CP/"

Plotter_PPsurrogs_tests(m=m,ans=ans,resloc=resloc)
```

```{r pedagog_fig, echo=F, results="hide"}
set.seed(seed)
#source("./pedagog_ts.R")

#------------------------------------------------------------------
# another pedagog fig. showing LT, UT with same correlation
library(copula)
library(VineCopula)
par_rho_0.8<-copula::iRho(claytonCopula(5),rho=0.8)
ccop<-BiCopSim(200,3,par=par_rho_0.8)
sccop<-BiCopSim(200,13,par=par_rho_0.8)
pdf("./Results/pedagog_figs/LTUT_rho_0.8.pdf",height=3,width=6)
op<-par(mfrow=c(1,2),mar=c(3.5, 3.5, 0.1, 1.1),mgp=c(1.8,0.5,0))
plot(ccop[,1],ccop[,2],col=rgb(0,0,0,0.1),pch=20,xlab="x",ylab="y",cex.lab=1.5,cex.axis=0.8,xaxs="i",yaxs="i")
lines(c(0,0.3),c(0.3,0),type='l')
lines(c(0,0.6),c(0.6,0),type='l')	
ind1<-which(ccop[,1]+ccop[,2]>0.3 & ccop[,1]+ccop[,2]<0.6)
points(ccop[ind1,1],ccop[ind1,2],col=rgb(1,0,0,0.1),pch=20)
lines(c(0,1),c(1,0),type='l',lty=2)

lines(c(0,1.4),c(1.4,0),type='l')	
lines(c(0,1.7),c(1.7,0),type='l')	
ind1<-which(ccop[,1]+ccop[,2]>1.4 & ccop[,1]+ccop[,2]<1.7)
points(ccop[ind1,1],ccop[ind1,2],col=rgb(0,0,1,0.1),pch=20)

#text(x=0.1,y=0.9,"A",cex=2)

plot(sccop[,1],sccop[,2],col=rgb(0,0,0,0.1),pch=20,xlab="x",ylab="y",cex.lab=1.5,cex.axis=0.8,xaxs="i",yaxs="i")
lines(c(0,0.3),c(0.3,0),type='l')
lines(c(0,0.6),c(0.6,0),type='l')	
ind1<-which(sccop[,1]+sccop[,2]>0.3 & sccop[,1]+sccop[,2]<0.6)
points(sccop[ind1,1],sccop[ind1,2],col=rgb(1,0,0,0.1),pch=20)

lines(c(0,1.4),c(1.4,0),type='l')	
lines(c(0,1.7),c(1.7,0),type='l')	
ind1<-which(sccop[,1]+sccop[,2]>1.4 & sccop[,1]+sccop[,2]<1.7)
points(sccop[ind1,1],sccop[ind1,2],col=rgb(0,0,1,0.1),pch=20)
lines(c(0,1),c(1,0),type='l',lty=2)

#text(x=0.1,y=0.9,"B",cex=2)

par(op)
#box(which="figure")
dev.off()
```

# Algorithm to generate extreme asymmetric tail dependence in a community matrix \label{extreme_taildep_mat} 

\noindent Random numbers were generated by first producing a $n$ by $d$ matrix, $m$, of 
independent standard-normal random draws, where $n$ is the length of time series and $d$
is the number of species in the community. Then, each row of $m$ 
was identified for a first set of modifications randomly 
and independently with a $50\%$ chance; 
for those rows identified, every element of the row was replaced with the 
absolute value of the first element of the row (including the first element itself).
For other rows, every element in the row was replaced by the negative of its
own absolute value. To make the matrix $m$ having non-negative numbers (as they correspond
to species-biomass), we gave a positive shift to all the entries in $m$. This produces 
right-tail dependent noise, normally distributed
for each location. If left-tail dependent noise is desired, take the negative of the
entire matrix.


# Algorithm to generate "tail-symmetric community" but with same Pearson correlation between any two species  \label{alg_pp_com} 

<!--See tex file by DCR -->


# Data \label{Data} 

<!--Hays data-->
For first dataset, we used basal cover of vascular plants mapped in permanent quadrats in 
Kansas mixed-grass prairieevery year from 1932-1972 [@adler2007long]. Researchers from 
Fort Hays State University, in Hays, Kansas, mapped all individual plants in a series 
of 1 sq. meter quadrats in a mixed grass prairie (38.8$^\circ$N, 99.3$^\circ$W) 
[@albertson1937ecology; @albertson1965vegation]. In fact, data produced 
using the pantograph technique can be used the same way as data generated by tagging
individual plants, with spatial coordinates substituting for tags. 
The Hays data set later had been digitized [@adler2007long] and is now available
[online](http://esapubs.org/archive/ecol/E088/161/). $41$ years (1932-1972)
long spatio-temporal data was widely used in earlier studies to understand plant demographic process. 
Here we will give a brief description of the [data](http://esapubs.org/archive/ecol/E088/161/).
`allrecords.csv` is basal cover (area in $cm^2$) datasets for 151 unique species (when observed) 
recorded for 41 years from 51 (1m $\times$ 1m) quadrats.
Counts for each unique species occurred in the entire `allrecords.csv` dataset 
were stored in `species_list.csv` file with categories like `type`, `PLANTS.Symbol`,
`PLANTS.Synonym` (for 
explanation see [`metadata file`](http://esapubs.org/archive/ecol/E088/161/metadata.htm)). 
5 of 151 species were classified in `'remove'` category as 
mentioned in `type` column of `species_list.csv`. They were non-plant 
species like `Bare ground`, `Fragment` and other unidentified sp. like
`Mixed grass`, `Polygonum spp.` (only occurred once), `Unknown`. Among 51 quadrats, 36 permanent 
quadrats were arranged along a gradient 
of soil depth and located in two livestock exclosures ("e1" and "e2"). Rest 15 quadrats 
were located in grazed areas outside the exclosures, mostly in the 
shortgrass community. Location of 51 quadrats were recorded as (quadX $cm$, quadY $cm$)
in East-West and North-South direction, respectively relative to the south-west corner 
of exclosure "e1" (see `quadrat_info.csv`). Each quadrat have some polygons with ID number processed 
in GIS tracking position for individual plants. Each polygon location was 
recorded as centroid co-ordinate (x $cm$, y $cm$) of corresponding 
polygon (see `allrecords.csv`). For our purpose, we computed basal 
cover time-series (1932-1972) averaged over the 36 quadrats within the exclosure 
for each of 146 species (excluding the `remove` category from 
151 species list). 

<!--add description about KNZ data-->
For second dataset, we used plant species composition data from [`Konza Prairie LTER site`](http://lter.konza.ksu.edu/content/pvc02-plant-species-composition-selected-watersheds-konza-prairie); data accessed on November, 2019 [@Hartnett2019]. The data 
collection is an ongoing project (1983 onwards)
where canopy coverage and frequency have been recorded for different 
burn treatment in ungrazed and grazed watersheds located in 
different topographic sites (upland 
topographic locations -florence soils, lowland topographic 
locations - tully soils, and slope locations). Only locations with florence soils and tully soils were 
sampled every year (1983-). For our purpose we chose watershed *001d* as 
it is the only one longest operated (1983-) ungrazed-annually burned watershed (for details see [`fire-history information`](http://lter.konza.ksu.edu/content/kfh011)). 
In this watershed, four 50 m long transects (A, B, C, and D) were established on each
topographic position and within each transect, five evenly spaced, permanently 
marked plots are located (so total 20 plots for each topographic position). Canopy cover are reported
in **7** classes (**1** <1%; **2** 1-5%; **3** 5-25%; **4** 25-50%; **5** 50-75%; **6** 75-95%; **7** 95-100%).
Species sampled on multiple census date in a year (initially started with three times a year but 1991 onwards 
sampling frequency changed to twice a year) we used the highest cover class for each plot. Finally, the 
percent cover for each plot was computed by averaging the mid-points of the cover classes for the 20 plots. This is in accordance with the method used in raw cover data processing (see [`methods manual for PVC02`](http://lter.konza.ksu.edu/sites/default/files/MM.pdf)). We presented our result considering average canopy cover sampled from tully soils only as we could not produce 
Pearson correlation preserving surrogate data for the other soiltype (florence soils) - this surrogates were used 
to answer (Q2) from \ref{MT-Introduction}.

<!--data category-->
For both datasets, we classified all the species into 3 distinct categories depending on their 
availability throughout the study period over all the quadrats considered. They are 
(i) "common sp." which were present at least 35 years,
(ii) "rare sp." which were present maximum for 2 years, (iii) the rests were
put into "intermediate" class. For tail dependence analysis,
we considered only the common sp. for each datasets (see 
Tables \ref{tab_spinfo_hays} and \ref{tab_spinfo_knz}) along with 
the other species merged into 
a single pseudo species. 

```{r make_tab_common_splist_for_hays, echo=F, results="asis"}
library(kableExtra)
library(dplyr)
tab_spinfo_hays<-as.data.frame(matrix(NA,nrow=19,ncol=3))
colnames(tab_spinfo_hays)<-c("ID","Sp. code","Species name")
tab_spinfo_hays$ID<-c(1:19)
tab_spinfo_hays$`Sp. code`<-c(as.character(spinfo$PLANTS.Symbol[which(spinfo$species %in% names(hays_spaceavg$avg.basal.cover))]),
                         "pseudo_hays")
splistfullnm<-c(names(hays_spaceavg$avg.basal.cover)[1:18],"This is a pseudo sp. = (intermediate + rare ones)")

tab_spinfo_hays$`Species name`<-c(splistfullnm)
knitr::kable(tab_spinfo_hays, 
             format="latex", align="c", linesep = "",
             caption = "Information of the most common species considered for Hays data; 19 most common species are selected based on the criterion that they had atleast 35 years of finite spatial averaged basal cover, for full list of all the species, including rare ones see Appendix \\ref{Data}.\\label{tab_spinfo_hays}", 
             booktabs = T,col.names = NULL) %>%
             column_spec(3,italic=T)%>%
             add_header_above(c("ID"=1,"Sp. code"=1,"Species name"=1))
```

```{r make_tab_common_splist_for_knz, echo=F, results="asis"}
# species list for knz (PPS01) is downloadable from: http://lter.konza.ksu.edu/content/pps01-konza-prairie-plant-species-list
library(kableExtra)
library(dplyr)
tab_spinfo_knz<-as.data.frame(matrix(NA,nrow=22,ncol=3))
colnames(tab_spinfo_knz)<-c("ID","Sp. code","Species name")
tab_spinfo_knz$ID<-c(1:22)
tab_spinfo_knz$`Sp. code`<-names(knz_spaceavg$avg.percent.cover)
splistfullnm<-c("Ambrosia psilostachya", "Andropogon gerardii", "Asclepias verticillata","Asclepias viridis",
                "Baptisia bracteata", "Bouteloua curtipendula", "Brickellia eupatorioides",
                "Dalea candida","Dichanthelium oligosanthes", "Dichanthelium	ovale",
                "Lespedeza capitata",
                "Mimosa quadrivalvis", "Panicum virgatum", 
                "Ruellia humilis", "Salvia azurea", "Schizachyrium scoparium", "solidago	altissima", 
                "Sorghastrum nutans",
                "Sporobolus compositus", "Symphyotrichum ericoides", "Vernonia baldwinii", "This is a pseudo sp.
                = (intermediate + rare ones)"
                )

tab_spinfo_knz$`Species name`<-c(splistfullnm)
knitr::kable(tab_spinfo_knz, 
             format="latex", align="c", linesep = "",
             caption = "Information of the most common species considered for KNZ data; 21 most common species are selected based on the criterion that they had 36 years of spatial averaged percent cover, for full list of all the species, including rare ones see Appendix \\ref{Data}.\\label{tab_spinfo_knz}", 
             booktabs = T,col.names = NULL) %>%
             column_spec(3,italic=T)%>%
             add_header_above(c("ID"=1,"Sp. code"=1,"Species name"=1))
```




<!--hays : npa results plot
\begin{figure}[!h]
\begin{center}
\textbf{ \hspace{0.5 cm} (A) \hspace{8 cm} (B)} \\
\includegraphics[width=8.5 cm]{./Results/hays_results/hays_npa_results/hays_spaceavg/hays_spaceavg_Corl-Coru.pdf}
\includegraphics[width=8.5 cm]{./Results/hays_results/hays_npa_results/hays_spaceavg/hays_spaceavg_Pl-Pu.pdf}\\
\vspace{1 cm}
\textbf{ \hspace{1 cm} (C) } \\
\includegraphics[width=8.5 cm]{./Results/hays_results/hays_npa_results/hays_spaceavg/hays_spaceavg_D2u-D2l.pdf}\\
\caption{ Non-parametric results for Hays space-averaged data for $(A)$ $\cor_l - \cor_u$, $(B)$ $\Ps_l - \Ps_u$ and
$(C)$ $\Dsq_u-\Dsq_l$. $nL$ and $nU$ indicate the numbers of lower tail and upper tail dependent cells (with positive correlation), respectively.\label{fig_hays_spaceavg_npa}}
\end{center}
\end{figure} -->

<!--hays : interspecific interaction : some plots-->

\begin{figure}[!h]
\begin{center}
\includegraphics[width=18 cm]{./Results/hays_results/hays_spaceavg_ANGE_PAVI2_PSTE5.pdf}
\caption[Upper tail-dependence among space-averaged basal cover of dry seasoned grasses in Hyas]
{Upper tail-dependence among space-averaged basal cover of dry seasoned grasses in Hyas; sp$_{-}$x 
and sp$_{-}$y are the id of species plotted along x- and y-axis, respectively. \label{fig_hays_spaceavg_dryseasoned_grass_UTdep}}
\end{center}
\end{figure}


\begin{figure}[!h]
\begin{center}
\includegraphics[width=14 cm]{./Results/hays_results/hays_spaceavg_SCSC_interactions.pdf}
\caption[Upper tail-dependence among space-averaged basal cover of dry seasoned grasses in Hyas]
{Upper tail-dependence among space-averaged basal cover of dry seasoned grasses in Hyas; sp$_{-}$x 
and sp$_{-}$y are the id of species plotted along x- and y-axis, respectively. Species in the y-axis 
of left column was reversed in the y-axis of right column so that species showed positive correlaion
in the copula plot; right column showed significant lower tail-dependent in pairwise copulas which was 
indicated in the red cells [(5,14), (5,12), (5,17) and (5,18)] of Fig. \ref{MT-fig_LTmUT_spaceavg_hays} 
in the maintext.\label{fig_hays_spaceavg_SCSC_interactions}}
\end{center}
\end{figure}


<!--hays & knz: time-series results plot-->
\begin{figure}[!h]
\begin{center}
\textbf{ \hspace{0.5 cm} (A) \hspace{5.5 cm} (B)} \\
\includegraphics[width=6 cm]{./Results/hays_results/skewness_results/total_timeseries.pdf}
\includegraphics[width=6 cm]{./Results/knz_results/skewness_results/total_timeseries_soiltype_t.pdf}\\
\caption[Timeseries plot for (A) Hays and $(B)$ KNZ data]{Timeseries plot for (A) Hays and $(B)$ KNZ data; "common" species indicate the most abundant species throughout years averaging over quadrats and present minimum for $35$ years. "Rare" species refer to the species which was present maximum for 2 years in both datasets. The rest are classified into "intermediate" category.\label{fig_spaceavg_timeseries}}
\end{center}
\end{figure}





\clearpage

# References

\indent

















